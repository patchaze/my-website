---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import CTABanner from '../../components/CTABanner.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map(post => ({
    params: { slug: post.slug },
    props:  { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const pubDateFormatted  = post.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
const modDateFormatted  = (post.data.modDate ?? post.data.pubDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
const modDateISO        = (post.data.modDate ?? post.data.pubDate).toISOString();
const pubDateISO        = post.data.pubDate.toISOString();
const canonicalURL      = `https://www.duriantravel.com/blog/${post.slug}/`;

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [{
    "@type": "Question",
    "name": "Is this visa guidance legal advice?",
    "acceptedAnswer": { "@type": "Answer", "text": "No. DURIAN provides educational content only. We are not immigration lawyers and do not provide legal advice or representation." }
  }]
};
---

<BaseLayout
  title={`${post.data.title} ‚Äî DURIAN`}
  description={post.data.description}
  canonical={canonicalURL}
  ogType="article"
  article={{
    author: post.data.author,
    datePublished: pubDateISO,
    dateModified: modDateISO,
    tags: post.data.tags
  }}
  breadcrumb={[
    { name: 'Blog', url: 'https://www.duriantravel.com/blog/' },
    { name: post.data.title, url: canonicalURL }
  ]}
>
  <div class="container">
    <Breadcrumb items={[
      { name: 'Blog', href: '/blog/' },
      { name: post.data.title }
    ]} />
  </div>

  <article class="post-layout">
    <div class="container container--narrow">

      <!-- Post header -->
      <header class="post-header">
        <div class="post-header__tags">
          {post.data.tags.map(tag => <span class="tag">{tag}</span>)}
        </div>
        <h1 class="post-header__title">{post.data.title}</h1>
        <p class="post-header__desc">{post.data.description}</p>
        <div class="post-header__meta">
          <div class="post-meta-author">
            <div class="post-meta-avatar" aria-hidden="true">PA</div>
            <div class="post-meta-info">
              <a href="/about-us/" class="post-meta-name">{post.data.author}</a>
              <div class="post-meta-dates">
                <time datetime={pubDateISO}>Published: {pubDateFormatted}</time>
                {post.data.modDate && (
                  <span> ¬∑ <time datetime={modDateISO}>Updated: {modDateFormatted}</time></span>
                )}
                <span> ¬∑ {post.data.readTime} min read</span>
              </div>
            </div>
          </div>
        </div>
        <div class="notice notice--warning post-disclaimer">
          <span aria-hidden="true">‚ö†Ô∏è</span>
          <span>
            <strong>Educational content only.</strong> This article is not legal advice.
            Always verify requirements on official embassy websites.
            <a href="/disclaimer/" class="link">Full disclaimer ‚Üí</a>
          </span>
        </div>
      </header>

      <!-- Post content -->
      <div class="prose post-content">
        <Content />
      </div>

      <!-- Author box -->
      <aside class="author-box" aria-label="About the author">
        <div class="author-box__avatar" aria-hidden="true">PA</div>
        <div class="author-box__info">
          <strong class="author-box__name">{post.data.author}</strong>
          <p class="author-box__bio">
            Visa Application Strategy Consultant at DURIAN. Specialises in
            document preparation guidance, cover letter strategy, and refusal analysis.
            <strong>Not a lawyer.</strong> Educational guidance only.
          </p>
          <a href="/about-us/" class="link" style="font-size:var(--text-sm)">About the consultant ‚Üí</a>
        </div>
      </aside>

      <!-- Related links -->
      <nav class="post-related" aria-label="Related services">
        <h2 class="post-related__title">Get Personalised Guidance</h2>
        <div class="post-related__grid">
          <a href="/services/document-review/" class="post-related__card">
            <span class="post-related__icon">üìÑ</span>
            <span>Document Review</span>
          </a>
          <a href="/services/cover-letter-strategy/" class="post-related__card">
            <span class="post-related__icon">‚úâÔ∏è</span>
            <span>Cover Letter Strategy</span>
          </a>
          <a href="/free-visa-audit/" class="post-related__card post-related__card--cta">
            <span class="post-related__icon">üéØ</span>
            <span>Free Visa Audit ‚Üí</span>
          </a>
        </div>
      </nav>

    </div>
  </article>

  <CTABanner />
</BaseLayout>

<style>
.post-layout { padding-block: var(--space-8); }

.post-header { margin-bottom: var(--space-10); }
.post-header__tags { display: flex; flex-wrap: wrap; gap: var(--space-2); margin-bottom: var(--space-4); }
.post-header__title {
  font-size: clamp(var(--text-2xl), 4vw, var(--text-4xl));
  line-height: 1.2;
  margin-bottom: var(--space-4);
}
.post-header__desc {
  font-size: var(--text-xl);
  color: var(--color-text-muted);
  line-height: var(--leading-relaxed);
  margin-bottom: var(--space-6);
}
.post-header__meta { margin-bottom: var(--space-5); }
.post-meta-author  { display: flex; align-items: center; gap: var(--space-3); }
.post-meta-avatar  {
  width: 44px; height: 44px;
  background: linear-gradient(135deg, var(--color-primary), var(--color-navy));
  border-radius: var(--radius-full);
  display: flex; align-items: center; justify-content: center;
  color: white; font-size: var(--text-sm); font-weight: var(--font-bold);
  flex-shrink: 0;
}
.post-meta-info    { display: flex; flex-direction: column; gap: 2px; }
.post-meta-name    { font-weight: var(--font-semibold); font-size: var(--text-sm); color: var(--color-primary); text-decoration: none; }
.post-meta-dates   { font-size: var(--text-xs); color: var(--color-text-muted); }
.post-disclaimer   { margin-top: var(--space-5); }

.post-content { margin-block: var(--space-10); }

.author-box {
  display: flex;
  gap: var(--space-4);
  background: var(--color-surface-2);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  margin-top: var(--space-12);
  border: 1px solid var(--color-border);
}
.author-box__avatar {
  width: 56px; height: 56px;
  background: linear-gradient(135deg, var(--color-primary), var(--color-navy));
  border-radius: var(--radius-full);
  display: flex; align-items: center; justify-content: center;
  color: white; font-size: var(--text-base); font-weight: var(--font-bold);
  flex-shrink: 0;
}
.author-box__name { font-size: var(--text-lg); font-weight: var(--font-bold); display: block; margin-bottom: var(--space-2); }
.author-box__bio  { font-size: var(--text-sm); color: var(--color-text-muted); line-height: var(--leading-relaxed); margin-bottom: var(--space-3); }

.post-related { margin-top: var(--space-10); }
.post-related__title { font-size: var(--text-xl); margin-bottom: var(--space-4); }
.post-related__grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); }
@media (max-width: 640px) { .post-related__grid { grid-template-columns: 1fr; } }
.post-related__card {
  display: flex; align-items: center; gap: var(--space-3);
  padding: var(--space-4);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  text-decoration: none;
  font-size: var(--text-sm);
  font-weight: var(--font-medium);
  color: var(--color-text);
  background: white;
  transition: all var(--transition-fast);
}
.post-related__card:hover { border-color: var(--color-primary); color: var(--color-primary); box-shadow: var(--shadow-sm); }
.post-related__card--cta  { background: var(--color-primary); color: white; border-color: var(--color-primary); }
.post-related__card--cta:hover { background: var(--color-primary-dark); }
.post-related__icon { font-size: 1.1rem; }
</style>
